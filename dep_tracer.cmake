function(validate_shell_script_extension FILE)
    
    set(SHARED_EXTENSIONS "py|cmake\\.json|custom\\.json")
    set(ALLOWED_EXTENSIONS "sh|${SHARED_EXTENSIONS}")
    message(STATUS "FILE: ${FILE}")
    if(WIN32)
        set(ALLOWED_EXTENSIONS "cmd|bat|ps1|${SHARED_EXTENSIONS}")  # Add other extensions as needed
    endif()
    string(REGEX MATCH "\\.(${ALLOWED_EXTENSIONS})$" EXT_VALIDATION_RESULT ${FILE})
    if(NOT EXT_VALIDATION_RESULT)
        
        if(WIN32)
            message(FATAL_ERROR "The allowed extensions are: \".cmd\", \".bat\", \".ps1\", \".py\" and \".cmake.json\"")
        else()
            message(FATAL_ERROR "The only allowed extensions are: \".sh\", \".py\" and \".cmake.json\"")
        endif()
    endif()
endfunction()

function(set_shell_program SCRIPT_FILENAME PYTHON_NAME_SUFFIX)
    # Get the file extension
    get_filename_component(SCRIPT_EXT "${SCRIPT_FILENAME}" EXT)
    string(TOLOWER "${SCRIPT_EXT}" SCRIPT_EXT)
    string(REPLACE "." "" SCRIPT_EXT "${SCRIPT_EXT}")

    set(SCRIPT_RUNNER "bash")
    set(SCRIPT_ARG "")

    if(SCRIPT_EXT STREQUAL "py")
        if(PYTHON_NAME_SUFFIX STREQUAL "<EMPTY>")
            set(PYTHON_NAME_SUFFIX "")
        else()
            set(PYTHON_NAME_SUFFIX "${PYTHON_NAME_SUFFIX}")
		endif()
        set(SCRIPT_RUNNER "python${PYTHON_NAME_SUFFIX}")
        set(SCRIPT_ARG "")
    endif()

    if(SCRIPT_EXT STREQUAL "cmakejson")
		set(SCRIPT_RUNNER "RepoFetcher")
		set(SCRIPT_ARG "")
	endif()

    if(SCRIPT_EXT STREQUAL "customjson")
		set(SCRIPT_RUNNER "RepoFetcher")
		set(SCRIPT_ARG "")
	endif()

    if(SCRIPT_EXT STREQUAL "mesonjson")
		set(SCRIPT_RUNNER "RepoFetcher")
		set(SCRIPT_ARG "")
	endif()

    if(WIN32)
        if(SCRIPT_EXT STREQUAL "cmd" OR SCRIPT_EXT STREQUAL "bat")
            set(SCRIPT_RUNNER "cmd")
            set(SCRIPT_ARG "/c")
        elseif(SCRIPT_EXT STREQUAL "ps1")
            set(SCRIPT_RUNNER "powershell")
            set(SCRIPT_ARG "-File")
        endif()
    endif()

    # Export to parent scope
    set(SCRIPT_RUNNER "${SCRIPT_RUNNER}" PARENT_SCOPE)
    set(SCRIPT_ARG "${SCRIPT_ARG}" PARENT_SCOPE)
endfunction()

macro(trace_dependency)
    set(oneValueArgs "INSTALL_SCRIPT" "NAME" "VERSION" "COMPONENT_INFIX" "PYTHON_NAME_SUFFIX" "WORKING_DIR")
    set(options "USE_VSTOOLS" "LIMIT_SEARCH_PATHS")
    set(multiValueArgs "COMPONENTS" "EXTRA_SUFFIXES")
    cmake_parse_arguments(PACKAGE_CONTROLLER "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if((NOT DEFINED PACKAGE_CONTROLLER_NAME) OR (NOT DEFINED PACKAGE_CONTROLLER_INSTALL_SCRIPT))
        message(FATAL_ERROR "NAME and INSTALL_SCRIPT are required arguments")
    endif()

    if(NOT DEFINED PACKAGE_CONTROLLER_PYTHON_NAME_SUFFIX)
        set(PACKAGE_CONTROLLER_PYTHON_NAME_SUFFIX "<EMPTY>")
    endif()

    if((NOT DEFINED PACKAGE_CONTROLLER_COMPONENT_INFIX))
        set(PACKAGE_CONTROLLER_COMPONENT_INFIX)
    endif()

    if(NOT DEFINED PACKAGE_CONTROLLER_WORKING_DIR)
		set(PACKAGE_CONTROLLER_WORKING_DIR ".")
	endif()

    set(TREATED_USE_VSTOOLS FALSE)
    if((DEFINED PACKAGE_CONTROLLER_USE_VSTOOLS) AND MSVC)
        set(TREATED_USE_VSTOOLS TRUE)
    endif()

    set(TREATED_LIMIT_SEARCH_PATHS FALSE)
    if(DEFINED PACKAGE_CONTROLLER_LIMIT_SEARCH_PATHS)
        set(TREATED_LIMIT_SEARCH_PATHS TRUE)
    endif()

    set(VERSION_ARG)
    if(DEFINED ${PACKAGE_CONTROLLER_VERSION})
        set(VERSION_ARG VERSION)
    endif()

    set(USE_EXTRA_SUFFIX FALSE)
    if(DEFINED PACKAGE_CONTROLLER_EXTRA_SUFFIXES)
        set(USE_EXTRA_SUFFIX TRUE)
    endif()
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        if(USE_EXTRA_SUFFIX)
            find_package(${PACKAGE_CONTROLLER_NAME} ${VERSION_ARG} ${PACKAGE_CONTROLLER_VERSION} COMPONENTS ${PACKAGE_CONTROLLER_COMPONENTS} PATHS ${CMAKE_INSTALL_PREFIX} NO_DEFAULT_PATH PATH_SUFFIXES ${PACKAGE_CONTROLLER_EXTRA_SUFFIXES})
        else()
            find_package(${PACKAGE_CONTROLLER_NAME} ${VERSION_ARG} ${PACKAGE_CONTROLLER_VERSION} COMPONENTS ${PACKAGE_CONTROLLER_COMPONENTS} PATHS ${CMAKE_INSTALL_PREFIX} NO_DEFAULT_PATH)
        endif()
    else()
        find_package(${PACKAGE_CONTROLLER_NAME} ${VERSION_ARG} ${PACKAGE_CONTROLLER_VERSION} COMPONENTS ${PACKAGE_CONTROLLER_COMPONENTS})
    endif()    
    list(LENGTH PACKAGE_CONTROLLER_COMPONENTS NUMBER_OF_COMPONENTS)

    if(NUMBER_OF_COMPONENTS EQUAL 0)
        if(${PACKAGE_CONTROLLER_NAME}_FOUND)
            message(STATUS "${PACKAGE_CONTROLLER_NAME} was found")
        else()
            download_package(${PACKAGE_CONTROLLER_INSTALL_SCRIPT} ${TREATED_USE_VSTOOLS} ${PACKAGE_CONTROLLER_PYTHON_NAME_SUFFIX} ${PACKAGE_CONTROLLER_WORKING_DIR})
        endif()
    else()
        set(ALL_COMPONENTS_FOUND "${PACKAGE_CONTROLLER_COMPONENTS}" ON)
        foreach(COMPONENT IN LISTS PACKAGE_CONTROLLER_COMPONENTS)
            if(NOT ${PACKAGE_CONTROLLER_NAME}${PACKAGE_CONTROLLER_COMPONENT_INFIX}${COMPONENT}_FOUND)
                set(ALL_COMPONENTS_FOUND OFF)
            endif()
        endforeach()
        if(ALL_COMPONENTS_FOUND)
            message(STATUS "${PACKAGE_CONTROLLER_NAME} was found, with all components")
        else()
            download_package(${PACKAGE_CONTROLLER_INSTALL_SCRIPT} ${TREATED_USE_VSTOOLS} ${PACKAGE_CONTROLLER_PYTHON_NAME_SUFFIX} ${PACKAGE_CONTROLLER_WORKING_DIR})
        endif()
    endif()
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_package(${PACKAGE_CONTROLLER_NAME} ${VERSION_ARG} ${PACKAGE_CONTROLLER_VERSION} COMPONENTS ${PACKAGE_CONTROLLER_COMPONENTS} PATHS ${CMAKE_INSTALL_PREFIX} NO_DEFAULT_PATH REQUIRED ${EXTRA_SUFFIX_ARG} ${TREATED_EXTRA_SUFFIXES})
    else()
        find_package(${PACKAGE_CONTROLLER_NAME} ${VERSION_ARG} ${PACKAGE_CONTROLLER_VERSION} COMPONENTS ${PACKAGE_CONTROLLER_COMPONENTS} REQUIRED)
    endif()

endmacro()

macro(trace_library)
    set(oneValueArgs "INSTALL_SCRIPT" "NAME" "PYTHON_NAME_SUFFIX" "WORKING_DIR")
    set(multiValueArgs "COMPONENTS")
    set(options "USE_VSTOOLS" "LIMIT_SEARCH_PATHS")
    cmake_parse_arguments(LIBRARY_CONTROLLER "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if((NOT DEFINED LIBRARY_CONTROLLER_NAME) OR (NOT DEFINED LIBRARY_CONTROLLER_INSTALL_SCRIPT))
        message(FATAL_ERROR "NAME and INSTALL_SCRIPT are required arguments")
    endif()
    
    if(NOT DEFINED LIBRARY_CONTROLLER_PYTHON_NAME_SUFFIX)
        set(LIBRARY_CONTROLLER_PYTHON_NAME_SUFFIX "")
    endif()

    if(NOT DEFINED LIBRARY_CONTROLLER_WORKING_DIR)
		set(LIBRARY_CONTROLLER_WORKING_DIR ".")
	endif()

    set(TREATED_USE_VSTOOLS FALSE)
    if((DEFINED LIBRARY_CONTROLLER_USE_VSTOOLS) AND MSVC)
        set(TREATED_USE_VSTOOLS TRUE)
    endif()

    set(TREATED_LIMIT_SEARCH_PATHS FALSE)
    if(DEFINED LIBRARY_CONTROLLER_LIMIT_SEARCH_PATHS)
        set(TREATED_LIMIT_SEARCH_PATHS TRUE)
    endif()

    if(TREATED_LIMIT_SEARCH_PATHS)
        find_library(${LIBRARY_CONTROLLER_NAME}_FOUND NAMES ${LIBRARY_CONTROLLER_NAME} PATHS ${CMAKE_INSTALL_PREFIX}/lib NO_DEFAULT_PATH)
    else()
        find_library(${LIBRARY_CONTROLLER_NAME}_FOUND NAMES ${LIBRARY_CONTROLLER_NAME} PATHS ${CMAKE_INSTALL_PREFIX}/lib)
    endif()
    
    if(NOT ${LIBRARY_CONTROLLER_NAME}_FOUND)
        download_package(${LIBRARY_CONTROLLER_INSTALL_SCRIPT} ${TREATED_USE_VSTOOLS} ${LIBRARY_CONTROLLER_PYTHON_NAME_SUFFIX} ${LIBRARY_CONTROLLER_WORKING_DIR})
    else()
        message(STATUS "${LIBRARY_CONTROLLER_NAME} was found")
    endif()
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_library(${LIBRARY_CONTROLLER_NAME}_FOUND NAMES ${LIBRARY_CONTROLLER_NAME} PATHS ${CMAKE_INSTALL_PREFIX}/lib NO_DEFAULT_PATH REQUIRED)
    else()
        find_library(${LIBRARY_CONTROLLER_NAME}_FOUND NAMES ${LIBRARY_CONTROLLER_NAME} PATHS ${CMAKE_INSTALL_PREFIX}/lib REQUIRED)
    endif()


endmacro()

macro(trace_file)
    set(oneValueArgs "INSTALL_SCRIPT" "LOCATION" "NAME" "EXTENSION" "PYTHON_NAME_SUFFIX" "WORKING_DIR")
    set(multiValueArgs "COMPONENTS")
    set(options "LIMIT_SEARCH_PATHS")
    cmake_parse_arguments(FILE_CONTROLLER "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if((NOT DEFINED FILE_CONTROLLER_NAME) OR (NOT DEFINED FILE_CONTROLLER_INSTALL_SCRIPT) OR (NOT DEFINED FILE_CONTROLLER_LOCATION) OR (NOT DEFINED FILE_CONTROLLER_EXTENSION))
        message(FATAL_ERROR "NAME, INSTALL_SCRIPT, LOCATION and EXTENSION are required arguments")
    endif()

    if(NOT DEFINED FILE_CONTROLLER_PYTHON_NAME_SUFFIX)
        set(FILE_CONTROLLER_PYTHON_NAME_SUFFIX "")
    endif()

    if(NOT DEFINED FILE_CONTROLLER_WORKING_DIR)
		set(FILE_CONTROLLER_WORKING_DIR ".")
	endif()

    set(TREATED_LIMIT_SEARCH_PATHS FALSE)
    if(DEFINED FILE_CONTROLLER_LIMIT_SEARCH_PATHS)
        set(TREATED_LIMIT_SEARCH_PATHS TRUE)
    endif()

    set(CMAKE_FIND_USE_CMAKE_ENVIRONMENT_PATH FALSE)
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} NO_DEFAULT_PATH)
    else()
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION})
    endif()
    
    if(NOT ${FILE_CONTROLLER_NAME}_FOUND)
        download_file(${FILE_CONTROLLER_INSTALL_SCRIPT} ${FILE_CONTROLLER_PYTHON_NAME_SUFFIX} ${FILE_CONTROLLER_WORKING_DIR})
    else()
        message(STATUS "${FILE_CONTROLLER_NAME} was found")
    endif()
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} NO_DEFAULT_PATH REQUIRED)
    else()
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} REQUIRED)
    endif()
    
    set(CMAKE_FIND_USE_CMAKE_ENVIRONMENT_PATH TRUE)

endmacro()

macro(trace_installable_file)
    set(oneValueArgs "INSTALL_SCRIPT" "LOCATION" "NAME" "EXTENSION" "PYTHON_NAME_SUFFIX" "WORKING_DIR")
    set(multiValueArgs "COMPONENTS")
    set(options "LIMIT_SEARCH_PATHS" "USE_VSTOOLS")
    cmake_parse_arguments(FILE_CONTROLLER "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    if((NOT DEFINED FILE_CONTROLLER_NAME) OR (NOT DEFINED FILE_CONTROLLER_INSTALL_SCRIPT) OR (NOT DEFINED FILE_CONTROLLER_LOCATION) OR (NOT DEFINED FILE_CONTROLLER_EXTENSION))
        message(FATAL_ERROR "NAME, INSTALL_SCRIPT, LOCATION and EXTENSION are required arguments")
    endif()

    set(TREATED_LIMIT_SEARCH_PATHS FALSE)
    if(DEFINED FILE_CONTROLLER_LIMIT_SEARCH_PATHS)
        set(TREATED_LIMIT_SEARCH_PATHS TRUE)
    endif()

    if(NOT DEFINED FILE_CONTROLLER_PYTHON_NAME_SUFFIX)
        set(FILE_CONTROLLER_PYTHON_NAME_SUFFIX "")
    endif()

    if(NOT DEFINED FILE_CONTROLLER_WORKING_DIR)
		set(FILE_CONTROLLER_WORKING_DIR ".")
	endif()
    
    set(TREATED_USE_VSTOOLS FALSE)
    if((DEFINED PACKAGE_CONTROLLER_USE_VSTOOLS) AND MSVC)
        set(TREATED_USE_VSTOOLS TRUE)
    endif()

    set(CMAKE_FIND_USE_CMAKE_ENVIRONMENT_PATH FALSE)
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} NO_DEFAULT_PATH)
    else()
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION})
    endif()

    if(NOT ${FILE_CONTROLLER_NAME}_FOUND)
        download_package(${FILE_CONTROLLER_INSTALL_SCRIPT} ${TREATED_USE_VSTOOLS} ${FILE_CONTROLLER_PYTHON_NAME_SUFFIX} ${FILE_CONTROLLER_WORKING_DIR})
    else()
        message(STATUS "${FILE_CONTROLLER_NAME} was found")
    endif()
    
    if(TREATED_LIMIT_SEARCH_PATHS)
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} NO_DEFAULT_PATH REQUIRED)
    else()
        find_file(${FILE_CONTROLLER_NAME}_FOUND NAMES "${FILE_CONTROLLER_NAME}.${FILE_CONTROLLER_EXTENSION}" PATHS ${FILE_CONTROLLER_LOCATION} REQUIRED)
    endif()

    set(CMAKE_FIND_USE_CMAKE_ENVIRONMENT_PATH TRUE)

endmacro()

macro(download_package INSTALL_SCRIPT USE_VSTOOLS PYTHON_NAME_SUFFIX WORKING_DIR)
    validate_shell_script_extension(${INSTALL_SCRIPT})
    set_shell_program(${INSTALL_SCRIPT} ${PYTHON_NAME_SUFFIX})
    set(PROJECT_BUILD_TYPE ${CMAKE_BUILD_TYPE})
    if(PROJECT_BUILD_TYPE STREQUAL "RelWithDebInfo")
        set(PROJECT_BUILD_TYPE "Release")
    endif()
    set(DIR_PREFIX "")
    if(NOT WIN32)
        if(NOT WORKING_DIR STREQUAL ".")
            set(DIR_PREFIX "${WORKING_DIR}")
            if(NOT DIR_PREFIX MATCHES "/$")
                set(DIR_PREFIX "${DIR_PREFIX}/")
            endif()
        endif()
    endif()
    if(${USE_VSTOOLS})
        execute_process(COMMAND ${DIR_PREFIX}${SCRIPT_RUNNER} ${SCRIPT_ARG} ${INSTALL_SCRIPT} ${PROJECT_BUILD_TYPE} ${CMAKE_INSTALL_PREFIX} ${PROJECT_SOURCE_DIR} ${CMAKE_C_COMPILER} WORKING_DIRECTORY ${WORKING_DIR})
    else()
        execute_process(COMMAND ${DIR_PREFIX}${SCRIPT_RUNNER} ${SCRIPT_ARG} ${INSTALL_SCRIPT} ${PROJECT_BUILD_TYPE} ${CMAKE_INSTALL_PREFIX} ${PROJECT_SOURCE_DIR} WORKING_DIRECTORY ${WORKING_DIR})
    endif()
endmacro(download_package)

macro(download_file INSTALL_SCRIPT PYTHON_NAME_SUFFIX)
    validate_shell_script_extension(${INSTALL_SCRIPT})
    set_shell_program(${INSTALL_SCRIPT} ${PYTHON_NAME_SUFFIX})
    execute_process(COMMAND ${SCRIPT_RUNNER} ${SCRIPT_ARG} ${INSTALL_SCRIPT} ${PROJECT_SOURCE_DIR})
endmacro(download_file)
